<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>5&nbsp; Survival analysis I – Biological and Biomedical Data Science ([DSAN 6150](https://gu-dsan.github.io/6150-fall-2024/){target=_blank})</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/week-06.html" rel="next">
<link href="../chapters/week-04.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar docked nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Biological and Biomedical Data Science (</span></a><a href="https://gu-dsan.github.io/6150-fall-2024/" target="_blank">DSAN 6150</a>)
    
  </div>
        <div class="quarto-navbar-tools tools-end">
    <a href="https://github.com/araastat/6150-notes/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/week-05.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Survival analysis I</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="sidebar-tools-main">
    <a href="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to biological and biomedical data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Experimental design and confounding</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Causality</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Causal effect estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-05.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Survival analysis I</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Survival analysis II</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Applied machine learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/week-12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Machine learning explainability</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-technical-background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Technical background</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li>
<a href="#survival-data" id="toc-survival-data" class="nav-link" data-scroll-target="#survival-data">Survival data</a>
  <ul class="collapse">
<li><a href="#risk-sets" id="toc-risk-sets" class="nav-link" data-scroll-target="#risk-sets">Risk sets</a></li>
  <li><a href="#censoring" id="toc-censoring" class="nav-link" data-scroll-target="#censoring">Censoring</a></li>
  <li><a href="#the-nature-of-survival-data" id="toc-the-nature-of-survival-data" class="nav-link" data-scroll-target="#the-nature-of-survival-data">The nature of survival data</a></li>
  </ul>
</li>
  <li>
<a href="#survival-distributions" id="toc-survival-distributions" class="nav-link" data-scroll-target="#survival-distributions">Survival distributions</a>
  <ul class="collapse">
<li><a href="#statistics" id="toc-statistics" class="nav-link" data-scroll-target="#statistics">Statistics</a></li>
  <li><a href="#distributions" id="toc-distributions" class="nav-link" data-scroll-target="#distributions">Distributions</a></li>
  <li><a href="#simulating-survival-data-with-censoring" id="toc-simulating-survival-data-with-censoring" class="nav-link" data-scroll-target="#simulating-survival-data-with-censoring">Simulating survival data with censoring</a></li>
  </ul>
</li>
  <li>
<a href="#the-survival-curve" id="toc-the-survival-curve" class="nav-link" data-scroll-target="#the-survival-curve">The survival curve</a>
  <ul class="collapse">
<li><a href="#estimation-parametric-models" id="toc-estimation-parametric-models" class="nav-link" data-scroll-target="#estimation-parametric-models">Estimation: parametric models</a></li>
  <li><a href="#estimation-non-parametric-methods" id="toc-estimation-non-parametric-methods" class="nav-link" data-scroll-target="#estimation-non-parametric-methods">Estimation: non-parametric methods</a></li>
  <li><a href="#aligning-the-different-estimates" id="toc-aligning-the-different-estimates" class="nav-link" data-scroll-target="#aligning-the-different-estimates">Aligning the different estimates</a></li>
  </ul>
</li>
  <li>
<a href="#different-statistics" id="toc-different-statistics" class="nav-link" data-scroll-target="#different-statistics">Different statistics</a>
  <ul class="collapse">
<li><a href="#median-survival-time" id="toc-median-survival-time" class="nav-link" data-scroll-target="#median-survival-time">Median survival time</a></li>
  <li><a href="#mean-survival-time" id="toc-mean-survival-time" class="nav-link" data-scroll-target="#mean-survival-time">Mean survival time</a></li>
  <li><a href="#landmark-estimate" id="toc-landmark-estimate" class="nav-link" data-scroll-target="#landmark-estimate">Landmark estimate</a></li>
  </ul>
</li>
  <li>
<a href="#comparing-survival" id="toc-comparing-survival" class="nav-link" data-scroll-target="#comparing-survival">Comparing survival</a>
  <ul class="collapse">
<li><a href="#landmark-analysis" id="toc-landmark-analysis" class="nav-link" data-scroll-target="#landmark-analysis">Landmark analysis</a></li>
  <li><a href="#the-hazard-function-and-the-proportional-hazards-assumption" id="toc-the-hazard-function-and-the-proportional-hazards-assumption" class="nav-link" data-scroll-target="#the-hazard-function-and-the-proportional-hazards-assumption">The hazard function and the proportional hazards assumption</a></li>
  <li><a href="#sec-nph" id="toc-sec-nph" class="nav-link" data-scroll-target="#sec-nph">Non-proportional hazards and using RMST for comparison</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/araastat/6150-notes/edit/main/chapters/week-05.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/araastat/6150-notes/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-week5" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Survival analysis I</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p><strong>Last updated:</strong> 05 Oct, 2024 12:01 AM EDT</p>
<div class="callout callout-style-simple callout-warning">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Work in progress, target time 9/19 noon</p>
</div>
</div>
</div>
<section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>A common interest across a wide range of fields is to understand when and why things fail. In engineering, that can mean how long will a component of a car last with normal use. In healthcare, that can mean how long does a person with diabetes live. For many businesses, it can mean how long does an employee stay with the company, or how long does a subscriber stay with a plan. The general question is, how long before something (an <em>event</em>) happens. The adjacent question is, what affects how long before the event happens. Does metformin help a diabetic prolong the time before blindness and neuropathy set it? Does some incentive tend to keep subscribers subscribed longer? Does the Mediterranean diet increase the time until one might get a heart attack?</p>
<p>Looking at failure times and its influencers spawned a different way of using statistics and data, called <em>survival analysis</em> in the statistics/biomedical worlds and <em>reliability</em> in engineering, and <em>churn analytics</em> in business.</p>
<p>There are several things that make survival (which we’ll use here instead of the more general <em>failure time</em>) data unique.</p>
<ul>
<li><p>First is that it is always considered to be positive, since we have a time 0 when we start measuring time. This leads to particular choices in terms of the probability distributions that we consider when modeling survival analysis.</p></li>
<li>
<p>Second is that we often have to deal with missing data in a very particular sense, or perhaps data with incomplete information is a better way to put it. In practice, we can’t follow study units (humans, components, customers) forever, and so we stop tracking at some time point. At that point, several units might not have experienced failure yet, but we would reasonably believe that they would fail if we followed them long enough. So we only know, for these units, that they did not fail until the time at which we stopped following them. That <em>is</em> information, but it’s not the full information we would like. Survival analysis methods account for this partial information issue, which is formally called <strong>censoring</strong>. We’ll talk about this in more detail in a bit</p>
<ul>
<li>A similar issue in survival data is <strong>truncation</strong>. Suppose we’re doing a study where we follow patients from the start of their leukemia diagnosis to death. Some patients my enter the study from another hospital, where their diagnosis has happened, but they entered the study some time after. Their “clock” on the study started later than 0, and we consider their times <em>truncated</em>.</li>
</ul>
</li>
<li><p>Third is how we model covariates that affect (or perhaps cause) changes in survival times. Survival analysis uses statistics and metrics that are not used in other branches of statistics, thus requiring a bit of learning and a re-evaulation of our intuition.</p></li>
<li><p>Fourth is that the descriptive statistics and graphs we use are different from what you may have learned, both in terms of describing the data and in terms of evaluating model goodness-of-fit and residual analyses. Things get a bit specialized.</p></li>
</ul>
<p>In this chapter we approach the different ways of describing and modeling survival time itself, including reasonable probability distributions, statistics and how we look at changes or differences in survival curves. The next chapter will explore how we evaluate how features/covariates can affect survival times, and how we model that effect and evaluate how well our models do. We will focus on approaches that look at survival time as continuous, and acknowledge that approaches that use discretized time do exist and can also be useful.</p>
</section><section id="survival-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="survival-data">Survival data</h2>
<div class="page-columns page-full"><p>We start by following a cohort of patients from the time of admission into a study and see when they die. As the weeks go by, some patients die, and some patients leave the study either by choice or are <em>lost to followup</em>. At 12 weeks we stop the study and know that some of the patients we followed are still alive then. We can show this data graphically. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">Survival analysis generally is done on <strong>prospective</strong> data</span></div></div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">leukemia</span><span class="op">)</span> <span class="co"># Acute Myelogeneous Leukemia data</span></span>
<span></span>
<span><span class="va">leukemia</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fl">0</span>, ind <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">'Censored'</span>, <span class="st">"Died"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">start</span>, y <span class="op">=</span> <span class="va">ind</span>, xend <span class="op">=</span> <span class="va">time</span>, yend <span class="op">=</span> <span class="va">ind</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">ind</span>, color <span class="op">=</span> <span class="va">status</span>, shape <span class="op">=</span> <span class="va">status</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Weeks"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Follow-up time in a leukemia cohort, sorted by time of follow-up</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-tip">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The time when we start counting time, so-called time 0, may not always be obvious, and in an actual study may need to be defined. In many clinical studies, time starts either when the disease is diagnosed or when the patient is admitted to hospital. However, as you can imagine, that start time is actually different for different patients. We typically align the times so that the agreed-upon start time for time counting is always denoted as zero, regardless of what calendar time it occurs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/clipboard-897485810.png" class="img-fluid figure-img"></p>
<figcaption>In a hypothetical clinical study, we see how followup actually occurs in the left panel, where the dotted line denotes when the study stopped. Analytically, however, we transform the same observations on the study time scale to align all start times to 0, as in the right panel. Here, censoring is represented as an open circle. <em>From Aalen, Borgan and Gjessing, 2008</em>.</figcaption></figure>
</div>
</div>
</div>
</div>
<section id="risk-sets" class="level3"><h3 class="anchored" data-anchor-id="risk-sets">Risk sets</h3>
<p>At any given time <span class="math inline">\(t\)</span>, the risk set is defined as the group of individuals who are still at risk <em>in the study cohort</em> to experience an event. This means, we include in the risk set at time <span class="math inline">\(t\)</span> everyone in the study that we are still following at time <span class="math inline">\(t\)</span>. Anyone who has experienced an event before time <span class="math inline">\(t\)</span>, or individuals who are censored before time <span class="math inline">\(t\)</span>, are <strong>not</strong> included in the risk set at time <span class="math inline">\(t\)</span>.</p>
<p>A risk set is defined at every time during the period of the study.</p>
</section><section id="censoring" class="level3"><h3 class="anchored" data-anchor-id="censoring">Censoring</h3>
<p>There are generally 3 kinds of censoring that we consider:</p>
<ol type="1">
<li>Right censoring, where we know that a subject has survived up to a certain time, but we don’t observe the time of the survival event. This is by far the most common form of censoring and what most analyses account for.</li>
<li>Interval censoring, where we know that the event occurred between two time points, but we don’t know the exact time of the event. This is common for many practical studies, where, for example, we only know that cancer recurrence happened between two visits. Interval censoring can be important to account for in analysis, but it is often ignored if the time intervals between observations are reasonably small.</li>
<li>Left censoring, where we know that the event occurred before a certain point. For example, we find out a person has died because he didn’t show up to his next scheduled doctor’s visit.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/clipboard-3255178959.png" class="img-fluid figure-img"></p>
<figcaption>From Turkson, Aylah-Mensah &amp; Nimoh (2021). https://doi.org/10.1155/2021/9307475</figcaption></figure>
</div>
<p>A fundamental assumption that we make in incorporating censoring is that</p>
<blockquote class="blockquote">
<p>the censoring is independent of the survival outcome</p>
</blockquote>
<p>that is, whether you get censored or not, either during the followup period (lost to followup) or at the end of the study (administrative censoring), does not affect whether or not you experience the event, i.e.&nbsp;<em>noninformative censoring</em>. This is often seen as a reasonable assumption, especially if censoring happens for reasons extraneous to the disease under study, like, for example, the study stops on a certain date.</p>
<p>There are instances where this assumption fails, however. For example, patients might be more likely to drop out of a study if they are too sick to take the medication or go to hospital visits, so their censoring is related to the severity of their illness and likely is associated with their risk of dying. This is why the <em>independent censoring</em> assumption must be reasoned and checked. There are some techniques around accounting for such <em>informative censoring</em>, that will often include weighting schemes like we saw in the propensity score weighting. We’ll come back to this in a future section.</p>
</section><section id="the-nature-of-survival-data" class="level3"><h3 class="anchored" data-anchor-id="the-nature-of-survival-data">The nature of survival data</h3>
<p>Survival data is actually stored as a <strong>bivariate entity</strong> <span class="math inline">\((T, \delta)\)</span> , where <span class="math inline">\(T\)</span> denotes the observed survival time and <span class="math inline">\(\delta\)</span> is a 0-1 variable that denotes whether we observed the event(1) or censoring (0) at the end of the observed survival time. We need both to evaluate survival time.</p>
<div class="callout callout-style-simple callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Clinical data in CDISC format that can go to the FDA
</div>
</div>
<div class="callout-body-container callout-body">
<p>When dealing with data from registered clinical trials, the survival (or time-to-event data, denoted TTE) has to conform to a standard format based on the agreed-upon CDISC standard. In this format, you have a <em>censoring</em> variable (<code>CNSR</code>) rather than an <em>event</em> variable which is coded in reverse of the <span class="math inline">\(\delta\)</span> above, i.e.&nbsp;it codes being censored as 1 and having the event as 0. So one of the first lines of code we write is <code>cens &lt;- 1-CNSR</code> to accommodate the standard censoring variable that <i class="fa-brands fa-r-project" aria-label="r-project"></i> or <i class="fa-brands fa-python" aria-label="python"></i> assume.</p>
</div>
</div>
</section></section><section id="survival-distributions" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="survival-distributions">Survival distributions</h2>
<section id="statistics" class="level3"><h3 class="anchored" data-anchor-id="statistics">Statistics</h3>
<p>We look at different statistics that capture different aspects of the survival distribution, i.e, the distribution of survival times. In the following we denote the survival time by the <em>random variable</em> T, which has some distribution on the support <span class="math inline">\(T \geq 0\)</span>.</p>
<dl>
<dt>Survival function</dt>
<dd>
<p><span class="math inline">\(S(t) = P(T &gt; t) = 1 - P(T \leq t) = 1 - F(t)\)</span> for <span class="math inline">\(t \geq 0\)</span> is the probability that individual survives for at least time t</p>
</dd>
<dt>Hazard function</dt>
<dd>
<p>The hazard function <span class="math inline">\(h(t)\)</span> is the instantaneous chance that you will fail at time t given you have survived till then. <span class="math inline">\(h(t) = P(T = t | T \geq t) = \frac{f(t)}{S(t)}\)</span> where <span class="math inline">\(f(t)\)</span> is the p.d.f of the survival distribution (<span class="math inline">\(f(t) = \frac{dF(t)}{dt}\)</span>). It can also be defined as <span class="math inline">\(h(t) = -\frac{d}{dt} \ln(S(t))\)</span>.</p>
</dd>
<dt>Cumulative hazard function</dt>
<dd>
<p>The cumulative hazard function <span class="math inline">\(H(t) = -\ln(S(t)) = \int_0^\infty h(u)du\)</span> is, essentially, the sum of all the chances of failing over the period of observation. Mathematically, we can turn this around to show that <span class="math inline">\(S(t) = e^{-H(t)}\)</span></p>
</dd>
</dl>
<p>It turns out that the hazard function is the one we actually work with most of the time in terms of modeling, but we look at the survival time more descriptively.</p>
</section><section id="distributions" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="distributions">Distributions</h3>
<p>We use several distributions to model survival time. These include the exponential, Weibull and Gamma models. Details of these distributions are available in <a href="../01-technical-background.html" class="quarto-xref"><span>Appendix A</span></a>. For the purposes of survival analysis, these properties of the Exponential and Weibull distributions are</p>
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 28%">
<col style="width: 46%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Exponential</th>
<th>Weibull</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Hazard rate</td>
<td><span class="math inline">\(h(t) = \lambda\)</span></td>
<td><span class="math inline">\(h(t) = \lambda k t^{k-1}\)</span></td>
</tr>
<tr class="even">
<td>p.d.f.</td>
<td>f(t) = <span class="math inline">\(\lambda e^{-\lambda t}\)</span>
</td>
<td>f(t) = <span class="math inline">\(\lambda k t^{k-1} e^{-\lambda t^k}\)</span>
</td>
</tr>
<tr class="odd">
<td>Survival function</td>
<td>S(t) = <span class="math inline">\(e^{-\lambda t}\)</span>
</td>
<td>S(t) = <span class="math inline">\(e^{-\lambda t^k}\)</span>
</td>
</tr>
<tr class="even">
<td>Mean</td>
<td><span class="math inline">\(\mu = 1/\lambda\)</span></td>
<td><span class="math inline">\(\mu = \frac{\Gamma(1+1/k)}{\lambda^k}\)</span></td>
</tr>
<tr class="odd">
<td>Median</td>
<td><span class="math inline">\(-\log(0.5)/\lambda\)</span></td>
<td><span class="math inline">\(-\left(\frac{\log (0.5)}{\lambda}\right)^{1/k}\)</span></td>
</tr>
</tbody>
</table>
<p>We can consider <span class="math inline">\(\lambda\)</span> as the <em>rate</em> at which events occur. A larger <span class="math inline">\(\lambda\)</span> means that the average survival time goes down, which means you have more events per unit time. A really nice interpretation of <span class="math inline">\(k\)</span> is available <a href="https://en.wikipedia.org/wiki/Weibull_distribution">here</a>.</p>
<p>One property of this that derives from the survival function of the Weibull distribution uses the complementary log function (<a href="#eq-cll" class="quarto-xref">Equation&nbsp;<span>5.1</span></a>)</p>
<p><span id="eq-cll"><span class="math display">\[
\log (- \log S(t)) = \log \lambda + k\log t
\tag{5.1}\]</span></span></p>
<div class="page-columns page-full"><p>So the complementary log transformation (log(-log(t)) is linear in log t, which can serve as a test for the adequacy of the Weibull model in fitting the data. .</p><div class="no-row-height column-margin column-container"><span class="margin-aside">Note that the Exponential is the Weibull with k=1</span></div></div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More general property<iconify-icon role="img" inline="" icon="mdi:thought-bubble" style="font-size: 1.5em;" aria-label="Icon thought-bubble from mdi Iconify.design set." title="Icon thought-bubble from mdi Iconify.design set."></iconify-icon>
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Theorem:</strong> If T is a continuous non-negative random variable with cumulative hazard function <span class="math inline">\(\Lambda\)</span>. Then the random variable <span class="math inline">\(Y = \Lambda(T)\)</span> follows an exponential distribution with rate <span class="math inline">\(\lambda = 1\)</span>.</p>
<p>This property allows us to plot a quantile-quantile plot of <strong>the modelled</strong> <span class="math inline">\(\Lambda(T)\)</span> against an exponential(1) distribution to see how well the model fit is.</p>
<pre class="{webr-r week-05-3}"><code>#| fig-width: 3
set.seed(20348)
library(ggplot2)
library(dplyr)
d &lt;- tibble(
    T = rweibull(1000, 5, scale=3) # Simulated survival times (no censoring). FEEL FREE TO PLAY HERE
  ) |&gt; 
  arrange(T) |&gt; 
  mutate(
    Ft = (1:n())/n(), # empirical c.d.f.
    St = 1-Ft,        # empirical survival function
    Lt = -log(St)    # empirical hazard function
    )
ggplot(d, aes(sample = Lt))+
  geom_qq(distribution = stats::qexp) + 
  geom_qq_line(distribution = stats::qexp) + 
  theme_bw() + 
  labs(x = "Exponential(1) quantiles", y = "Empirical cumulative hazard function")+
  coord_equal()
</code></pre>
</div>
</div>
</section><section id="simulating-survival-data-with-censoring" class="level3"><h3 class="anchored" data-anchor-id="simulating-survival-data-with-censoring">Simulating survival data with censoring</h3>
<p>Being able to simulate survival distributions is often quite useful. We saw above how to simulate some survival times based on non-negatve distributions. However, in reality, we will encounter right-censoring at the very least. For this, we need to understand further the nature of survival data.</p>
<p>Each observation is associated with two times: the survival time <span class="math inline">\(T^*_i\)</span> and the censoring time <span class="math inline">\(C_i\)</span>. What we actually observe is</p>
<p><span class="math display">\[
T_i = \min(T^*_i, C_i)\\
\delta_i = \begin{cases}
1 &amp; T_i^* \leq C_i\\
0 &amp; T_i^* &gt; C_i
\end{cases}
\]</span> We can simulate data in a similar fashion</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2393</span><span class="op">)</span></span>
<span><span class="va">nsim</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>Tstar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html">rweibull</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="fl">0.8</span><span class="op">)</span>, <span class="co"># Survival distribution</span></span>
<span>censor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsim</span><span class="op">)</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span>                     <span class="co"># Censoring distribution</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>T <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="va">Tstar</span>, <span class="va">censor</span><span class="op">)</span>,</span>
<span>         delta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Tstar</span> <span class="op">&lt;=</span> <span class="va">censor</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>indx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>delta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">delta</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Event"</span>, <span class="st">"Censored"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">0</span>, xend <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="va">indx</span>, yend<span class="op">=</span><span class="va">indx</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="va">indx</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span><span class="st">"Status"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'white'</span>,<span class="st">'black'</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="the-survival-curve" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="the-survival-curve">The survival curve</h2>
<p>The survival curve for a population is a graph plotting <span class="math inline">\(S(t)\)</span> against <span class="math inline">\(t\)</span>, where you can read off, for any time point, the proportion of the population still alive at that time point; conversely for any particular quantile of survival, you can read off the time to reach that quantile (for example median survival when 50% of the population remains.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">48</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">*</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Probability of survival"</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Exponential(0.1) distribution'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Generally speaking, <strong>if we don’t have censoring</strong>, we can generate the empirical survival curves, quite easily.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  T <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>St <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">St</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Survival probability"</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If there is censoring, let’s see what happens if we ignore the censoring and just plot the reported survival times.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">d</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span>, </span>
<span>            Tobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">cens</span><span class="op">)</span>,</span>
<span>            delta <span class="op">=</span> <span class="cn">T</span> <span class="op">&lt;=</span> <span class="va">cens</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">Tobs</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>St1 <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Tobs</span>, <span class="va">St1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">St</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">pexp</a></span><span class="op">(</span><span class="cn">T</span>, <span class="fl">2</span>, lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span>,color <span class="op">=</span> <span class="st">'orange'</span>, linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Time'</span>, y <span class="op">=</span> <span class="st">'Probability of survival'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We find that ignoring censoring (black line) <strong>biases our estimates</strong> of survival compared to a no censoring situation (red line), which aligns with the generative model (orange dashed line). This is reasonable since for the censored observations, we’re counting them as having the event at that time rather than having the event <em>after</em> that time, and so inflate the failure rates.</p>
<section id="estimation-parametric-models" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="estimation-parametric-models">Estimation: parametric models</h3>
<p>Generally speaking, parametric models are fit via maximum likelihood, where the likelihood function is</p>
<p><span class="math display">\[
L(\theta|T_i) = \Pi f(t_i | \theta)^{\delta_i} S(t_i)^{1-\delta_i}
\]</span></p>
<p>So, for example, if we assume an exponential model, we would find <span class="math inline">\(\lambda\)</span> to maximize</p>
<p><span class="math display">\[
L(\lambda | T) = \Pi_{i=1}^n (\lambda e^{-\lambda t_i})^{\delta_i} (e^{-\lambda t_i})^{(1-\delta_i)}
\]</span></p>
<p>We simulate data from an Exponential(0.8) distribution and add censoring. We then do a grid search to find the maximum value of the likelihood function described above.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2393</span><span class="op">)</span></span>
<span><span class="va">nsim</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>Tstar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="fl">0.8</span><span class="op">)</span>, <span class="co"># Survival distribution</span></span>
<span>censor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsim</span><span class="op">)</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span>                     <span class="co"># Censoring distribution</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>T <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="va">Tstar</span>, <span class="va">censor</span><span class="op">)</span>,</span>
<span>         delta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Tstar</span> <span class="op">&lt;=</span> <span class="va">censor</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>indx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>delta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">delta</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Event"</span>, <span class="st">"Censored"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lik_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lambda</span>, <span class="va">d</span>, <span class="va">times</span><span class="op">=</span><span class="st">"T"</span>,<span class="va">cens</span> <span class="op">=</span> <span class="st">"cens"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">times</span> <span class="op">=</span> <span class="va">d</span><span class="op">[[</span><span class="va">times</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">cens</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[[</span><span class="va">cens</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">2</span> <span class="co"># quirky conversion, basically higher level</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">lambda</span>, \<span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">dexp</a></span><span class="op">(</span><span class="va">times</span><span class="op">[</span><span class="va">cens</span><span class="op">]</span>, rate<span class="op">=</span><span class="va">l</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">pexp</a></span><span class="op">(</span><span class="va">times</span><span class="op">[</span><span class="op">!</span><span class="va">cens</span><span class="op">]</span>, rate<span class="op">=</span><span class="va">l</span>, lower.tail<span class="op">=</span><span class="cn">F</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span> </span>
<span><span class="co"># Here we do grid search to find the maximum of the function</span></span>
<span><span class="va">lmda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">lmda_hat</span> <span class="op">=</span> <span class="va">lmda</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="fu">lik_fn</span><span class="op">(</span><span class="va">lmda</span>, <span class="va">d</span>, times <span class="op">=</span> <span class="st">'T'</span>, cens <span class="op">=</span> <span class="st">'delta'</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The optimization gives the estimate of the exponential parameter as 0.83.</p>
<p>Another way of approaching the problem that uses the same method uses the <code>survreg</code> function, which we’ll see more of next week as we look at survival regression.Note, in R, we use the function <code>Surv</code> to incorporate the bivariate survival data into models.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">delta</span><span class="op">==</span><span class="st">'Event'</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">d</span>, dist <span class="op">=</span> <span class="st">'exponential'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The estimate we get from here is 0.831.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>A note here on notation. Here we’re only trying to estimate one survival curve, so the right side of the equation is <code>1</code>. We’ll see in a bit how that gets modified when we start looking at groups.</p>
</div></div><p>We can also plot the predicted survival curve from the <code>survreg</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>                         <span class="co"># Probability of death</span></span>
<span><span class="va">pred_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>,type <span class="op">=</span> <span class="st">'quantile'</span>, p <span class="op">=</span> <span class="va">probs</span><span class="op">)</span>  <span class="co"># predicted times</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  probs <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">probs</span>,  <span class="co"># convert to survival probability</span></span>
<span>  times <span class="op">=</span> <span class="va">pred_times</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">times</span>, y <span class="op">=</span> <span class="va">probs</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="estimation-non-parametric-methods" class="level3"><h3 class="anchored" data-anchor-id="estimation-non-parametric-methods">Estimation: non-parametric methods</h3>
<p>The most common way to estimate the survival curve is the <strong>Kaplan-Meier curve</strong>, which provides an unbiased estimate of the survival curve in the presence of independent censoring. It appears as a step function which is constant between failure times, and the vertical jump at each failure time is inversely proportional to the number of individuals still at risk at that time.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="va">sfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">delta</span><span class="op">==</span><span class="st">'Event'</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sfit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A more refined (and personally preferred) version is using the <strong>ggsurvfit</strong> package which is aligned with <strong>ggplot2</strong>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pharmaverse/ggsurvfit">ggsurvfit</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/survfit2.html">survfit2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">delta</span><span class="op">==</span><span class="st">'Event'</span><span class="op">)</span><span class="op">~</span><span class="fl">1</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/ggsurvfit.html">ggsurvfit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_risktable.html">add_risktable</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="aligning-the-different-estimates" class="level3"><h3 class="anchored" data-anchor-id="aligning-the-different-estimates">Aligning the different estimates</h3>
<p>We see that accounting for censoring reduces the bias in estimating the survival curve. We’ve generated the data from an exponential model, so the parametric method does very well (it uses the exponential to fit). The Kaplan-Meier method is known to generate unbiased estimates generally as long as the censoring is non-informative.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://allancameron.github.io/geomtextpath/">geomtextpath</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pharmaverse/ggsurvfit">ggsurvfit</a></span><span class="op">)</span></span>
<span><span class="va">plt_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>times <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="cn">T</span>, cens <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">delta</span><span class="op">==</span><span class="st">'Event'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>St <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ggdata</span> <span class="op">=</span> <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/survfit2.html">survfit2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">times</span>, <span class="va">cens</span><span class="op">)</span><span class="op">~</span><span class="fl">1</span>, data<span class="op">=</span><span class="va">plt_data</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/tidy_survfit.html">tidy_survfit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plt_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plt_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">times</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">pexp</a></span><span class="op">(</span><span class="va">times</span>, rate <span class="op">=</span> <span class="fl">0.8</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Truth"</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plt_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">times</span>, y <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">pexp</a></span><span class="op">(</span><span class="va">times</span>, rate <span class="op">=</span> <span class="va">lmda_hat</span>, lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Parametric"</span><span class="op">)</span>,  linewidth<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ggdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">estimate</span>, color <span class="op">=</span> <span class="st">'KM'</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">times</span>, <span class="va">St</span>, color <span class="op">=</span> <span class="st">'Ignore censoring'</span> <span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Survival probability"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Method"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Truth"</span> <span class="op">=</span> <span class="st">'green'</span>, <span class="st">'Parametric'</span><span class="op">=</span><span class="st">'orange'</span>, <span class="st">"KM"</span> <span class="op">=</span> <span class="st">'blue'</span>, <span class="st">"Ignore censoring"</span> <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="different-statistics" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="different-statistics">Different statistics</h2>
<p>There are different metrics that can help summarise a survival distribution for the purposes of comparing different distributions or reporting landmarks.</p>
<section id="median-survival-time" class="level3"><h3 class="anchored" data-anchor-id="median-survival-time">Median survival time</h3>
<p>In the literature, the statistic we see most commonly is the <em>median survival time</em>. Due to censoring, we also have to be careful in estimating it, and need to use censoring-aware methods like the previous section, since it is derived from the estimated survival curve.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/survfit2.html">survfit2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">delta</span><span class="op">==</span><span class="st">"Event"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span> <span class="co"># can also use survfit</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">sfit</span>, probs <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  quantile lower upper
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1    0.814 0.742 0.888</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/ggsurvfit.html">ggsurvfit</a></span><span class="op">(</span><span class="va">sfit</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_quantile.html">add_quantile</a></span><span class="op">(</span>y_value <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="mean-survival-time" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="mean-survival-time">Mean survival time</h3>
<p>The mean survival time seems an attractive metric; how long on average to subjects in the population survive? However, when we want to estimate mean survival time in the presence of censoring, we run into problems. In particular, if the survival curve doesn’t touch the x-axis, which means that there remain some censored individuals at the end of followup, the mean survival time remains undefined, since theoretically the unknown survival times could be <span class="math inline">\(\infty\)</span>.</p>
<div class="page-columns page-full"><p>What can be computed is the <strong>restricted mean survival time (RMST)</strong>, which asks what is the average survival time during a defined time period. It is “computed” as the area under the survival curve up to some specified time. We will use the <i class="fa-brands fa-r-project" aria-label="r-project"></i> package <strong>RISCA</strong> to compute the RMST.. This statistic is useful for comparing two survival curves, as we’ll see in a bit.</p><div class="no-row-height column-margin column-container"><span class="margin-aside"><code>install.packages('RISCA')</code></span></div></div>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RISCA</span><span class="op">)</span></span>
<span><span class="va">sdata</span> <span class="op">&lt;-</span> <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">sfit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sdata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="week-05_files/figure-html/week-05-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">sdata</span>, <span class="fu"><a href="https://rdrr.io/pkg/RISCA/man/rmst.html">rmst</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">estimate</span>, max.time <span class="op">=</span> <span class="fl">2</span>, type <span class="op">=</span> <span class="st">'s'</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9730756</code></pre>
</div>
</div>
</section><section id="landmark-estimate" class="level3"><h3 class="anchored" data-anchor-id="landmark-estimate">Landmark estimate</h3>
<p>We’re often interested in the proportion of units who have survived to a particular time. In drug trials this is often 1-, 2- or 5-year survival. This is a binary outcome of yes (survived to the landmark time) or no (had an event before the landmark time).</p>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Be careful with the definition above. An error is commonly made with creating the outcome variable. Only individuals in the risk set at the landmark time receive a “no” or 0, and only individuals who have experienced an event at or before the landmark time are given a “yes” or 1. Anyone who has been censored before the landmark time is given a missing value (<code>NA</code>), since we don’t know what their outcome status at the landmark time is.</p>
</div>
</div>
</div>
<p>The landmark estimate is the proportion of ‘yes’/1s in the variable described above, ignoring the observatins that are marked as <code>NA</code>. To be precise,</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Landmark estimate = (# with an event at or before the landmark time)/(# who were not censored before the landmark time)</p>
<p>The denominator inludes everyone in the numerator + everyone in the <a href="#risk-sets">risk set</a> at the landmark time.</p>
</div>
</div>
</div>
</section></section><section id="comparing-survival" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="comparing-survival">Comparing survival</h2>
<p>A central aspect of survival analysis is to compare the survival experience of patients who are exposed to different treatments or have different genetic profiles. The inference that we wish to make is that survival under one condition is longer than under another condition.</p>
<p>When we want to see if a new drug is better than existing treatments, we first design a randomized clinical trial where subjects are randomly assigned to the new treatment (T) or the standard of care (C). We then follow subjects going forward until the planned end of the study and observe the planned outcome (which can be disease recurrence, death, progression of disease or something else). Some individuals end up being censored due to drop-out or remaining alive at the end of the study. For each group of patients (which are called treatment arms), we can construct a survival curve, perhaps using the Kaplan-Meier technique. So what does it mean to say that indivudals on treatment have better survival than people on standard of care?</p>
<p>There are two broad approaches to answering this question.</p>
<ul>
<li>The first is <strong>landmark analysis</strong>, where we see how patients are doing after a certain amount of time on the study, often 1-, 2- or 5-years.</li>
<li>The second approach is to ask if the overall survival experience for the treatment group is better than that of the standard of care group.</li>
</ul>
<section id="landmark-analysis" class="level3"><h3 class="anchored" data-anchor-id="landmark-analysis">Landmark analysis</h3>
<p>We saw <a href="#landmark-estimate">earlier</a> how to compute the landmark estimate. For each arm of a trial (or each subgroup/stratum in the study), you can compute the landmark estimate for that arm. The landmark estimate is a proportion, and so we can use a two-sample test for proportions to evaluate the difference between the landmark estimates from two arms.</p>
<p>Let’s look at an example of doing this using the in-built dataset <code>colon</code> from a clinical trial of adjuvant chemotherapy in Stage B/C colon cancer. We will compare the 2 year overall survival between different treatment arms. We first compute the 2-year overall survival fo each of the three arms.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="va">colon_os</span> <span class="op">&lt;-</span> <span class="va">colon</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">etype</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">colon_os</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">*</span><span class="fl">365</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">*</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">rx</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">status</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  rx       prop
  &lt;fct&gt;   &lt;dbl&gt;
1 Obs     0.661
2 Lev     0.665
3 Lev+5FU 0.751</code></pre>
</div>
</div>
<p>We will now test if the Lev+5FU arm does better than the Lev arm.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/infer">infer</a></span><span class="op">)</span></span>
<span><span class="va">test_dat</span> <span class="op">&lt;-</span> <span class="va">colon_os</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">*</span><span class="fl">365</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">*</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">!=</span> <span class="st">'Obs'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="va">rx</span><span class="op">)</span>,</span>
<span>  status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="co"># convert to survival</span></span>
<span><span class="va">obs_stat</span> <span class="op">=</span> <span class="va">test_dat</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://infer.tidymodels.org/reference/specify.html">specify</a></span><span class="op">(</span><span class="va">status</span> <span class="op">~</span> <span class="va">rx</span>, success <span class="op">=</span> <span class="st">'1'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://infer.tidymodels.org/reference/calculate.html">calculate</a></span><span class="op">(</span><span class="st">'diff in props'</span>, order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Lev+5FU'</span>, <span class="st">'Lev'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_dat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://infer.tidymodels.org/reference/specify.html">specify</a></span><span class="op">(</span><span class="va">status</span> <span class="op">~</span> <span class="va">rx</span>, success <span class="op">=</span> <span class="st">'1'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://infer.tidymodels.org/reference/hypothesize.html">hypothesize</a></span><span class="op">(</span>null <span class="op">=</span> <span class="st">'independence'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://infer.tidymodels.org/reference/generate.html">generate</a></span><span class="op">(</span>reps <span class="op">=</span><span class="fl">5000</span>, <span class="st">'permute'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://infer.tidymodels.org/reference/calculate.html">calculate</a></span><span class="op">(</span><span class="st">'diff in props'</span>, order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Lev+5FU'</span>, <span class="st">'Lev'</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://infer.tidymodels.org/reference/get_p_value.html">get_p_value</a></span><span class="op">(</span><span class="va">obs_stat</span>, <span class="st">'right'</span><span class="op">)</span> <span class="co"># one-sided (greater) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  p_value
    &lt;dbl&gt;
1  0.0242</code></pre>
</div>
</div>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Try to see whether there is a significant difference at 5 years.</p>
</div>
</div>
</div>
</section><section id="the-hazard-function-and-the-proportional-hazards-assumption" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="the-hazard-function-and-the-proportional-hazards-assumption">The hazard function and the proportional hazards assumption</h3>
<p>What we’ve set out to do is to see if two survival curves are different in some sense. Intuitively we want to see two survival curves with one entirely above the other, to have a clear case that the survival experience in one group is better than that of the other.</p>
<p>Let’s look at the exponential distribution. The exponential distribution is characterised by a single parameter, the hazard. Suppose the two groups have hazards <span class="math inline">\(\lambda_1\)</span> and <span class="math inline">\(\lambda_2\)</span>. If <span class="math inline">\(\lambda_1 &gt; \lambda_2\)</span>, then we will have <span class="math inline">\(\exp(-\lambda_1 t) &lt; \exp(-\lambda_2 t)\)</span> or <span class="math inline">\(S(t|\lambda_1) &lt; S(t|\lambda_2)\)</span></p>
<p>So, for an exponential distribution, the hazard, which is a constant, characterises the distribution, and if the hazard increases, we see the survival function decreases uniformly at all times, making a clear case that survival in one group is clearly better than the other for all times <span class="math inline">\(t\)</span>.</p>
<p>This idea can be extended. It turns out, if the hazards of two survival curves are <strong>proportional</strong>, i.e.&nbsp;the ratio of the hazards is a constant independent of time, then one survival curve will be uniformly above the the other curve and the superiority of one survival experience is clear. This is called the <strong>proportional hazards assumption</strong></p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Digging a bit into the the PH assumption <iconify-icon role="img" inline="" icon="mdi:thought-bubble" style="font-size: 1.5em;" aria-label="Icon thought-bubble from mdi Iconify.design set." title="Icon thought-bubble from mdi Iconify.design set."></iconify-icon>
</div>
</div>
<div class="callout-body-container callout-body">
<p>We recall that <span class="math inline">\(S(t) = \exp\left(-\int_0^\infty h(u)du\right)\)</span>. If the two groups have hazard functions <span class="math inline">\(h_1(t)\)</span> and <span class="math inline">\(h_2(t)\)</span>. If we assume that <span class="math inline">\(h_2(t) = \gamma h_1(t)\)</span> for some <span class="math inline">\(\gamma &gt; 1\)</span> (the PH assumption). Then we have</p>
<p><span class="math display">\[
\begin{array}{ll}
S_2(t) &amp;=&amp; \exp\left(-\int_0^\infty h_2(u)du\right)\\
&amp;=&amp; \exp\left( -\int_0^\infty \gamma h_1(u) du\right)\\
&amp;=&amp; \exp\left( -\gamma \int_0^\infty h_1(u) du\right)\\
&amp;=&amp; S_1(t)^\gamma
\end{array}
\]</span></p>
<p>The proportional hazards assumption thus implies that one survival curve is uniformly higher than the other.</p>
<p>I’ll state that since <span class="math inline">\(\gamma &gt; 1\)</span>, <span class="math inline">\(h_2(t) &gt; h_1(t),\ \forall t\)</span> which, in turn, implies <span class="math inline">\(S_2(t) &lt; S_1(t)\)</span>. <strong>Convince yourself of this.</strong> The heuristics are quite clear, in that a higher hazard means you have more events per unit time, which means there are more events earlier which makes the survival curve be lower.</p>
</div>
</div>
<p>The PH assumption thus allows us to judge relative survival through the hazard functions, in particular, we look at the <strong>hazard ratio</strong> which is independent of time under the PH assumption. We can formulate a hypothesis test in this situation as</p>
<p><span class="math display">\[
H_0: HR = 1\ \text{vs}\ H_1: HR \neq 1
\]</span></p>
<p>The formal hypothesis test that tests this hypothesis is called the <strong>log-rank test</strong>, which is a form of <span class="math inline">\(\chi^2\)</span>-test. This test works provided (a) the censoring is uninformative and the rates of censoring are the same in both arms, (b) proportional hazards. We can perform the log-rank test directly in R.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="va">difftest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data <span class="op">=</span> <span class="va">colon</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">!=</span> <span class="st">'Obs'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># difftest$pvalue</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get a p-value of p&lt;0.000001.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>The <code>survdiff</code> function exposes the p-value in a slot named “pvalue”, which is different from the much more common “p.value”. To maintain uniformity, you can do <code>broom::tidy(difftest)$p.value</code></p>
</div></div><p>This p-value is obtained under the PH assumption, but we can use resampling to estimate the p-value as well.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org">rsample</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2893</span><span class="op">)</span></span>
<span><span class="va">resamples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/permutations.html">permutations</a></span><span class="op">(</span><span class="va">colon</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">!=</span> <span class="st">"Obs"</span><span class="op">)</span>, permute <span class="op">=</span> <span class="va">rx</span>, times <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">obs_stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">rx</span>, data <span class="op">=</span> <span class="va">colon</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">!=</span> <span class="st">'Obs'</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">chisq</span></span>
<span><span class="va">null_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">resamples</span><span class="op">$</span><span class="va">splits</span>, \<span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span><span class="op">~</span> <span class="va">rx</span>, data <span class="op">=</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/as.data.frame.rsplit.html">analysis</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">chisq</span><span class="op">)</span></span>
<span><span class="va">p.value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">null_dist</span> <span class="op">&gt;</span> <span class="va">obs_stat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The permutation p-value is &lt; 2.22e-16</p>
</section><section id="sec-nph" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="sec-nph">Non-proportional hazards and using RMST for comparison</h3>
<p>In order to compare survival curves, we need some overall metric that summarizes the survival curve. We will demonstrate how to use the RMST to compare survival distributions by strata.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><code>install.packages("survRM2")</code></p>
</div></div><div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">survRM2</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">colon</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">!=</span> <span class="st">"Obs"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survRM2/man/rmst2.html">rmst2</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>, status <span class="op">=</span> <span class="va">status</span>, arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">==</span> <span class="st">"Lev+5FU"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">unadjusted.result</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_scientific.html">fmt_scientific</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="cbxmkaspyx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#cbxmkaspyx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#cbxmkaspyx thead, #cbxmkaspyx tbody, #cbxmkaspyx tfoot, #cbxmkaspyx tr, #cbxmkaspyx td, #cbxmkaspyx th {
  border-style: none;
}

#cbxmkaspyx p {
  margin: 0;
  padding: 0;
}

#cbxmkaspyx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#cbxmkaspyx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#cbxmkaspyx .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#cbxmkaspyx .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#cbxmkaspyx .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cbxmkaspyx .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cbxmkaspyx .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cbxmkaspyx .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#cbxmkaspyx .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#cbxmkaspyx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#cbxmkaspyx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#cbxmkaspyx .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#cbxmkaspyx .gt_spanner_row {
  border-bottom-style: hidden;
}

#cbxmkaspyx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#cbxmkaspyx .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#cbxmkaspyx .gt_from_md > :first-child {
  margin-top: 0;
}

#cbxmkaspyx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#cbxmkaspyx .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#cbxmkaspyx .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#cbxmkaspyx .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#cbxmkaspyx .gt_row_group_first td {
  border-top-width: 2px;
}

#cbxmkaspyx .gt_row_group_first th {
  border-top-width: 2px;
}

#cbxmkaspyx .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbxmkaspyx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#cbxmkaspyx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#cbxmkaspyx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cbxmkaspyx .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbxmkaspyx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#cbxmkaspyx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#cbxmkaspyx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#cbxmkaspyx .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cbxmkaspyx .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cbxmkaspyx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbxmkaspyx .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cbxmkaspyx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbxmkaspyx .gt_left {
  text-align: left;
}

#cbxmkaspyx .gt_center {
  text-align: center;
}

#cbxmkaspyx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#cbxmkaspyx .gt_font_normal {
  font-weight: normal;
}

#cbxmkaspyx .gt_font_bold {
  font-weight: bold;
}

#cbxmkaspyx .gt_font_italic {
  font-style: italic;
}

#cbxmkaspyx .gt_super {
  font-size: 65%;
}

#cbxmkaspyx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#cbxmkaspyx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#cbxmkaspyx .gt_indent_1 {
  text-indent: 5px;
}

#cbxmkaspyx .gt_indent_2 {
  text-indent: 10px;
}

#cbxmkaspyx .gt_indent_3 {
  text-indent: 15px;
}

#cbxmkaspyx .gt_indent_4 {
  text-indent: 20px;
}

#cbxmkaspyx .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="header gt_col_headings">
<th id="Est." class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Est.</th>
<th id="lower .95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">lower .95</th>
<th id="upper .95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">upper .95</th>
<th id="p" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">p</th>
</tr></thead>
<tbody class="gt_table_body"><tr class="odd">
<td class="gt_row gt_right" headers="Est.">396.6133</td>
<td class="gt_row gt_right" headers="lower .95">245.8437</td>
<td class="gt_row gt_right" headers="upper .95">547.3829</td>
<td class="gt_row gt_right" headers="p">2.52 × 10<sup>−7</sup>
</td>
</tr></tbody>
</table>
</div>
</div>
</div>
<p>This gives a confidence interval and p-value based on large-sample (asymptotic) considerations. A better evaluation would be based on permuation testing.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org">rsample</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2845</span><span class="op">)</span></span>
<span><span class="va">permutes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/permutations.html">permutations</a></span><span class="op">(</span></span>
<span>  <span class="va">colon</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">!=</span> <span class="st">"Obs"</span><span class="op">)</span>,</span>
<span>  permute <span class="op">=</span> <span class="va">rx</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">10000</span></span>
<span><span class="op">)</span></span>
<span><span class="va">obs_stat</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">unadjusted.result</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">null_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span></span>
<span>  <span class="va">permutes</span><span class="op">$</span><span class="va">splits</span>,</span>
<span>  \<span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/as.data.frame.rsplit.html">analysis</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/survRM2/man/rmst2.html">rmst2</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>, status <span class="op">=</span> <span class="va">status</span>, arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">==</span> <span class="st">"Lev+5FU"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">unadjusted.result</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">null_dist</span> <span class="op">&gt;=</span> <span class="va">obs_stat</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">pval</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">pval</span> <span class="op">&lt;-</span> <span class="st">"&lt; 0.0001"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The permutation-based p-value is &lt; 0.0001.</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.araastat\.com\/6150-notes");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/week-04.html" class="pagination-link" aria-label="Causal effect estimation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Causal effect estimation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/week-06.html" class="pagination-link" aria-label="Survival analysis II">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Survival analysis II</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright Abhijit Dasgupta (2024). All rights reserved</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/araastat/6150-notes/edit/main/chapters/week-05.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/araastat/6150-notes/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org">Quarto</a></p>
</div>
  </div>
</footer>


</body></html>